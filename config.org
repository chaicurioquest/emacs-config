#+TITLE: Emacs Literate Config
#+TODO: ACTIVE | CANCELLED
#+STARTUP: indent
#+DATE: \today
#+FILETAGS: ::
#+OPTIONS: toc:t num:nil
# OPTIONS: toc:nil num:2
#+PROPERTY: header-args :eval never-export
#+CREATED: 2025-07-12
#+LAST_MODIFIED: [2025-08-12 Tue 16:06]


* Purpose
This Org-mode configuration is the single source for my Emacs 30 setup, designed to be:
- **Future-proof**: Structured with comments, tables, CANCELLED blocks.
- **Reliable**: Reproducible packages via straight.el, lazy loading.
- **Minimal**: Single config.org, minimal hooks/keybindings, early-init.el for GUI, unified tag management.
- **Portable**: Device-specific settings (laptop, Termux, tablet) via device.el.
- **Synced**: Via GitHub[](https://github.com/chaicurioquest/emacs-config) and Syncthing.
- **Modular**: Uses org/ for snippets (yankpad.org), org-extension (orgxtn.org),  workflows (workflows.org), and note-taking (**roam.org**).  **<-- Updated reference for consistency with file rename**
Tangle with `C-c t` or `M-x my-tangle-config-org`.

* My Digital Workflow :workflow:
| Workflow                     | Solution                          | Notes                                                                 | Device     | Keybindings                          |
|------------------------------|-----------------------------------|-----------------------------------------------------------------------|------------|--------------------------------------|
| Installing packages          | use-package with straight.el      | Lazy loading in config.org; workflows.org optional (commented)        | All        | None                                 |
| Filter Org files             | sparse trees                      | Built-in Org feature for filtering headings                           | All        | C-c /                                |
| Focus on Org sub-hierarchy   | org-tree-to-indirect-buffer       | Built-in Org for narrowing to subtree                                 | All        | C-c C-x b                            |
| Enhanced search/selection    | vertico, orderless                | Vertical completion and fuzzy matching; Ivy optional in workflows.org (commented) | All    | None (uses Vertico for completion)   |
| Switching buffers            | ibuffer                           | Improved buffer list management                                       | All        | C-x C-b                              |
| Inserting date/time-stamps   | my-insert-timestamp(), my-insert-datestamp(), my-insert-org-timestamp() | Custom functions for timestamps (including Org format)              | All        | C-c i t, C-c i d, C-c i g           |
| Org to PDF export            | Org mode export via LaTeX (AUCTeX)| Uses auctex, reftex for refs; pdf-tools for viewing; configured in org/orgxtn.org | All/Laptop | C-c C-e l p                          |
| Passwords                    | org-crypt                         | Encrypt Org sections                                                  | All        | None                                 |
| Snippet management           | yankpad with yasnippet            | Org-style snippets in yankpad.org, tab-completion                     | All        | C-c y (insert), C-c Y (expand), C-c TAB |
| Spell checking               | flyspell with aspell              | Requires aspell; M-$ for correction                                   | All        | M-$                                  |
| PDF notextn/annotating       | pdf-tools, org-noter              | pdf-tools for viewing/highlighting; org-noter for synced annotations in notes | Laptop/All | None (M-x org-noter for annotations) |
| PDF side preview             | my/org-pdf-vertical-view          | Opens corresponding PDF in right split for quick view; configured in org/orgxtn.org | All | C-c v                                |
| Record screencasts           | gif-screencast                    | Optional in workflows.org (commented out)                             | Laptop     | C-c g                                |
| Zettelkasten note-taking     | org-roam                          | In org/roam.org; graph UI on laptop; dailies capture; backlinking with IDs | All   | C-c r n (capture), C-c r f (find), C-c r g (UI), C-c r d (dailies) |
| Bibliography/Citations       | citar, org-roam-bibtex            | Zotero integration; insert citations; bib notes in roam               | All        | C-c r c (open note/resource)         |
| Inserting citations          | citar-insert-citation             | Inserts BibTeX citations with Citar                                   | All        | C-c i c                              |
| Tag Org sections             | .filetags                         | In org/filetags.org; tag completion with Vertico                      | All        | C-c f t                              |
| Tangling config              | org-babel-tangle, my-tangle-all   | Tangles config.org or all modular files                               | All        | C-c t (single), C-c T (all)          |
| Org capture                  | org-capture                       | Captures generic notes using template; configured in org/orgxtn.org | All  | C-c c                                |
| Toggle Org items             | org-toggle-item                   | Converts text to/from list items                                      | All        | C-c i i                              |
| Window navigation/switching  | windmove, winner-mode, ace-window | Smart movement between windows; undo/redo layouts; fast jumping       | All        | Shift+Arrow (move), C-c left/right (undo/redo), M-o (ace jump) |
| Executing code blocks        | Org Babel                         | Enables shell and other languages in Org files; configured in org/orgxtn.org | All | C-c C-c (in block)                   |

* ACTIVE Startup Optimizations
;; modular org files tangle process.Tangling only happens when the .org file is newer than the .el file. Each .el file is loaded once after tangling.

#+BEGIN_SRC emacs-lisp
(defun my/tangle-if-needed (org-file el-file)
  "Tangle ORG-FILE to EL-FILE if needed, and load EL-FILE.
Skips if no changes; handles errors gracefully without deleting files."
  (let* ((org-path (expand-file-name org-file user-emacs-directory))
         (el-path (expand-file-name el-file user-emacs-directory)))
    (condition-case err
        (when (or (not (file-exists-p el-path))
                  (file-newer-than-file-p org-path el-path))
          (message "[%s] Tangling %s → %s" (format-time-string "%T") org-path el-path)
          (require 'org)
          (org-babel-tangle-file org-path el-path)
          (message "[%s] Tangled %s" (format-time-string "%T") el-path))
      (error (message "[%s] Tangling failed for %s: %s" (format-time-string "%T") org-path (error-message-string err))))
    (when (file-exists-p el-path)
      (load el-path nil 'nomessage)
      (message "[%s] Loaded %s" (format-time-string "%T") el-path))))
#+END_SRC

** Debug startup (toggle with MY_DEBUG_DEVICE environment variable).
#+BEGIN_SRC emacs-lisp
(when (getenv "MY_DEBUG_DEVICE")
  (message "=== STARTING CONFIG ==="))
#+END_SRC
** Reset garbage collection threshold to 2MB after startup.
#+BEGIN_SRC emacs-lisp
(add-hook 'emacs-startup-hook
  (lambda () (setq gc-cons-threshold (* 2 1000 1000))))
#+END_SRC

** Disable startup screen.
#+BEGIN_SRC emacs-lisp
(setq inhibit-startup-screen t)
#+END_SRC

** Load device detection.
#+BEGIN_SRC emacs-lisp
(condition-case err
    (load (expand-file-name "device.el" user-emacs-directory))
  (error (message "❌ Failed to load device.el: %s" (error-message-string err))))
#+END_SRC

** Set default directory per device.
#+BEGIN_SRC emacs-lisp
(setq default-directory
      (cond ((eq my-device 'laptop) (expand-file-name "org/" "/wspace/"))
            ((eq my-device 'tablet) (expand-file-name "org/" (getenv "HOME")))
            ((eq my-device 'phone) (expand-file-name "storage/notes" (getenv "HOME")))
            (t (getenv "HOME"))))

(unless (file-directory-p default-directory)
  (make-directory default-directory t))
    (message "Default directory: %s" default-directory)
#+END_SRC

** Global Variables

#+BEGIN_SRC emacs-lisp
;; Define paths early for global reuse (absolute/resolved for reliability)
(defvar bib-path (expand-file-name "bib/references.bib" default-directory)
  "Path to BibTeX file.")
(defvar my-citar-library-paths (list (expand-file-name "src/zotero-kbase/storage" "/wspace/"))
  "Citar library paths.")
(defvar setupfile (expand-file-name "latex/setup-latex.org" default-directory)
  "Org LaTeX setup file.")
(defvar org-roam-directory (expand-file-name "roam" default-directory)
  "Org-roam notes directory.")
(defvar org-roam-dailies-directory (expand-file-name "daily" org-roam-directory)
  "Org-roam dailies directory.")

(prefer-coding-system 'utf-8)
(setq default-buffer-file-coding-system 'utf-8)
#+END_SRC

** Tag-to-ID mappings for tag-based auto-refile script
#+BEGIN_SRC emacs-lisp
;; automatically refiling (moving) Org headings based on their tags added on 2025-09-20
(defcustom my-org-refile-to-ids nil
  "Tag to target ID mappings."
  :group 'sacha
  :type '(repeat (cons string string)))
#+END_SRC

** Org Roam dailiies path definition 
#+BEGIN_SRC emacs-lisp
(defvar org-roam-dailies-directory (expand-file-name "daily" org-roam-directory)
  "Directory for Org-roam dailies.")
#+END_SRC

** Customized Agenda view files on startup excluding roam, build, backup and other directory
#+BEGIN_SRC emacs-lisp
(defun my/update-agenda-files ()
  "Set `org-agenda-files` to top-level .org files in `default-directory`,
plus recursive .org files from the 'roam' subdirectory, excluding unwanted dirs."
  (interactive)
  (let* ((notes-dir (file-name-as-directory default-directory))
         (roam-dir (expand-file-name "roam/" notes-dir))
         (excluded-dirs '("build" "ltximg" "images" ".attach" ".autosaves" ".backups" "bib" "latex" ".git"))
         (dir-predicate (lambda (d)
                          (let ((dirname (file-name-nondirectory d)))
                            (not (or (string-prefix-p "." dirname)
                                     (member dirname excluded-dirs))))))
         ;; Top-level .org files in root
         (top-level-files (when (file-directory-p notes-dir)
                            (directory-files notes-dir t "\\.org\\'")))
         (top-level-orgs (seq-filter (lambda (f)
                                       (and (file-regular-p f)
                                            (not (string-match-p "/\\.#" f))))
                                     top-level-files))
         ;; Recursive .org files in roam
         (roam-files (when (file-directory-p roam-dir)
                       (directory-files-recursively roam-dir "\\.org\\'" nil dir-predicate)))
         (roam-orgs (seq-filter (lambda (f)
                                  (and (file-regular-p f)
                                       (not (string-match-p "/\\.#" f))))
                                roam-files))
         (all-orgs (append top-level-orgs roam-orgs)))
    (if (not all-orgs)
        (progn
          (setq org-agenda-files nil)
          (message "my/update-agenda-files: no valid .org files found in %s or roam/" notes-dir))
      (setq org-agenda-files all-orgs)
      (message "org-agenda-files set (%d files) from %s and roam/" (length org-agenda-files) notes-dir))))

;; Initialize once
(my/update-agenda-files)

;; Rescan only when saving an Org file under the notes dir (including subdirs like roam)
(add-hook 'after-save-hook
          (lambda ()
            (when (and (derived-mode-p 'org-mode)
                       buffer-file-name
                       (string-prefix-p (file-name-as-directory default-directory)
                                        (file-name-directory (file-truename buffer-file-name))))
              (my/update-agenda-files))))
#+END_SRC


** Debug: Confirm startup.
#+BEGIN_SRC emacs-lisp
(when (getenv "MY_DEBUG_DEVICE")
  (message "=== STARTUP OPTIMIZATIONS COMPLETE ==="))
#+END_SRC

* ACTIVE Package Management
Configure package managers and lightweight, universal packages with lazy loading.
Heavy or laptop-specific packages are in org/workflows.org; org-roam and bibliographic tools in org/roam.org; filetags in org/filetags.org.

| Package      | Purpose                          | Device       | Keybindings              | Loading Trigger          |
|--------------|----------------------------------|--------------|--------------------------|--------------------------|
| org          | Core Org-mode                    | All          | Org-mode keys            | Built-in                 |
| org-roam     | Zettelkasten note-taking         | All          | C-c r n, r f, r i, r g   | Startup                  |
| org-roam-bibtex | Zotero/BibTeX citation capture | All          |                          | org-roam-mode hook       |
| citar        | Bibliography interface           | All          | C-c i c                  | On demand                |
| org-roam-ui  | Graphical note graph (web UI)    | Laptop only  | C-c r g                  | M-x or keybinding        |
| f            | File/directory manipulation      | All          | None                     | On demand                |
| ht           | Hash table utilities             | All          | None                     | On demand                |
| ibuffer      | Buffer management                | All          | C-x C-b                  | C-x C-b                  |
| org-crypt    | Password encryption              | All          | None                     | org-mode hook            |
| cdlatex      | Math/equation input              | All          | TAB (contextual)         | TAB                      |
| yasnippet    | Snippet framework                | All          | TAB (inline yas-expand), C-c s (yas-insert-snippet) | TAB, C-c s            |
| yankpad      | Org-style snippet library        | All          | C-c y, C-c Y             | C-c y                    |
| flyspell     | Spell checking                   | All          | M-$                      | M-$                      |

** Org Base Configuration
#+BEGIN_SRC emacs-lisp
(use-package org
  :straight (:type built-in)
  :ensure nil
  :config
  ;; Core requires
  (require 'oc)
  (require 'oc-biblatex)
  ;; Enable refiling to any heading in agenda files (incl. roam/notes/mobile)
  (setq org-refile-targets '((org-agenda-files :maxlevel . 5)))
  (setq org-refile-use-outline-path 'file) ;; Show file paths in prompt
  (setq org-outline-path-complete-in-steps nil) ;; Complete in one step (Vertico fuzzy)
  (setq org-refile-allow-creating-parent-nodes 'confirm)
  (setq org-refile-use-cache t))  ;; Cache targets for speed
#+END_SRC

** Ensure use-package is available.
#+BEGIN_SRC emacs-lisp
(eval-when-compile
  (require 'use-package))
#+END_SRC

** File manipulation library (loaded on demand).
#+BEGIN_SRC emacs-lisp
(use-package f
  :straight t
  :defer t)
#+END_SRC

** Hash table utilities (loaded on demand).
#+BEGIN_SRC emacs-lisp
(use-package ht
  :straight t
  :defer t)
#+END_SRC

** Ibuffer for buffer management (loaded on C-x C-b).
#+BEGIN_SRC emacs-lisp
(use-package ibuffer
  :straight t
  :defer t
  :bind ("C-x C-b" . ibuffer))
#+END_SRC

** Encrypt org files
#+BEGIN_SRC emacs-lisp
(use-package org-crypt
  :ensure nil                        ;; Do not install from ELPA
  :straight nil                      ;; Do not use straight.el
  :defer t                           ;; Load when needed (on demand)
  :config
  (setq org-crypt-use-before-save nil) ;; Optional: prevent auto-encryption on save
  (require 'org-crypt))
#+END_SRC

** Flyspell for spell checking (loaded on M-$).
#+BEGIN_SRC emacs-lisp
(use-package flyspell
  :defer t
  :bind ("M-$" . flyspell-correct-word-before-point)
  :init
  ;; Force Hunspell with UK English dictionary
  (setq ispell-program-name "hunspell"
        ispell-dictionary "en_GB"
        ispell-local-dictionary "en_GB"
        ispell-local-dictionary-alist
        '(("en_GB" "[[:alpha:]]" "[^[:alpha:]]" "[']" t
           ("-d" "en_GB") nil utf-8)))
  :config
  ;; Enable flyspell everywhere you write text
  (add-hook 'text-mode-hook #'flyspell-mode)
  ;; For code: only check strings & comments
  (add-hook 'prog-mode-hook #'flyspell-prog-mode)

  ;; Correction interface for M-$
  (use-package flyspell-correct :straight t))

#+END_SRC

** CD Latex package for latex equations
#+BEGIN_SRC emacs-lisp
 (use-package cdlatex 
  :straight t 
  :defer t
  :hook (org-mode . org-cdlatex-mode))
#+END_SRC
   
** AUCTeX is an extensible package for writing and formatting TeX files in Emacs and XEmacs
#+BEGIN_SRC emacs-lisp
(use-package auctex
  :straight t
  :defer t  ;; Load on demand
  :hook (LaTeX-mode . (lambda () (turn-on-reftex) (flyspell-mode)))  ;; Optional: RefTeX for refs, spell-check
  :config
  (setq TeX-auto-save t
        TeX-parse-self t))
#+END_SRC

** Yasnippet package for adding snippets in org files
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :straight t
  :bind ("C-c s" . yas-insert-snippet)  ;; Pop up selectable snippets (e.g., tbl, fig)
  :config
  (yas-global-mode 1)
  (setq yas-indent-line 'fixed)  ;; Preserves indentation
  (add-to-list 'yas-snippet-dirs (expand-file-name "snippets" user-emacs-directory))
  (yas-reload-all)
  (add-hook 'org-mode-hook #'yas-minor-mode)
  :diminish yas-minor-mode)
#+END_SRC


** Yankpad: Org-mode snippet library on top of Yasnippet
#+BEGIN_SRC emacs-lisp
(use-package yankpad
  :straight t
  :bind
  (("C-c Y" . yankpad-expand)  ;; Expand snippet at point with yasnippet evaluation
   ("C-c y" . yankpad-insert)) ;; Insert snippet as plain text (no evaluation)
  :config
  ;; Set yankpad file in a portable location
  (setq yankpad-file (expand-file-name "org/yankpad.org"
                                       user-emacs-directory))
  ;; Ensure directory exists
  (let ((yankpad-dir (file-name-directory yankpad-file)))
    (unless (file-directory-p yankpad-dir)
      (make-directory yankpad-dir t)))

  ;; Load snippets immediately
  (yankpad-reload)

  ;; Optional: auto-reload in Org buffers
  (add-hook 'org-mode-hook #'yankpad-reload))

#+END_SRC

** Vertico: vertical completion UI Work well with org-roam (and Emacs in general) much faster, more flexible, and user-friendly. 
#+BEGIN_SRC emacs-lisp
(use-package vertico
  :straight t
  :defer t
  :init
  (vertico-mode))
#+END_SRC

** Orderless: smart fuzzy matching for completion
#+BEGIN_SRC emacs-lisp
(use-package orderless
  :straight t
  :defer t
  :custom
  (completion-styles '(orderless))
  (completion-category-defaults nil)
  (completion-category-overrides '((file (styles partial-completion)))))
#+END_SRC

** Future enhancement Consult package: enhanced commands. :future:
Powerful, fast,and flexible search/navigation UI (search, buffer switch, etc.) for working with Org-roam and Emacs in general.It can be enabled later for future optimization.

#+BEGIN_SRC emacs-lisp 
(use-package consult
  :straight t
  :bind
  (("C-s" . consult-line)
  ("C-c h" . consult-org-heading)
  ("C-c k" . consult-ripgrep)
  ("C-c b" . consult-buffer)
  ("C-c p" . consult-find)))
#+END_SRC

** RefTeX for Advanced Citation/Ref Handling.
If using AUCTeX for LaTeX exports, add reftex package.

#+BEGIN_SRC emacs-lisp
(use-package reftex
  :straight t
  :defer t
  :diminish reftex-mode)
#+END_SRC


** pdf tools: Enable in-buffer PDF viewing in Emacs (rather than opening PDFs in external viewers)
;; Use features like highlighting, annotations, or text selection. Work along with org-noter for taking notes synchronized with PDF pages
;; Updated on 2025-08-15 for support termux build in android devices.
#+BEGIN_SRC emacs-lisp
;; Install and configure PDF Tools as default PDF viewer
(use-package pdf-tools
  :straight t
  :defer t  ; Load on demand
  :init
  ;; Only enable on devices where it makes sense (e.g., skip on phone/tablet if performance is an issue)
  (unless (memq my-device '(phone tablet))
    (pdf-loader-install))  ; Changed to lazy/on-demand install
  :config
  ;; Optional tweaks for better integration
  (setq pdf-view-display-size 'fit-page  ; Fit to page by default
        pdf-view-continuous t)           ; Smooth scrolling
  ;; Enable Org-Noter integration with PDF Tools
  (with-eval-after-load 'org-noter
    (require 'org-noter-pdftools)
    (add-to-list 'org-noter-notes-window-behavior '(org-noter-pdftools-jump-to-note)))
  :mode ("\\.pdf\\'" . pdf-view-mode))  ; Override DocView for PDFs
#+END_SRC


** pdf annotation org noter optional dependancies
#+BEGIN_SRC emacs-lisp
;; Optional for org-noter EPUB/DJVU (suppress warnings if not used)
(use-package nov
  :straight t
  :defer t)

(use-package djvu
  :straight t
  :defer t)
#+END_SRC

** bibtex-completion for bibtex citar implementation
#+BEGIN_SRC emacs-lisp
;; -----------------------------
;; Marginalia — Rich Annotations (metadata for minibuffer)
;; -----------------------------
(use-package marginalia
  :straight t
  :init (marginalia-mode)
  :config
  (setq marginalia-align 'right)
  (message "✅ Marginalia annotations active."))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; -----------------------------
;; Embark — Contextual Actions
;; -----------------------------
(use-package embark
  :straight t
  :bind (("C-." . embark-act) ;; main action key
         ("C-;" . embark-dwim)) ;; smart default action
  :config
  (setq prefix-help-command #'embark-prefix-help-command)
  (message "✅ Embark contextual actions active."))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; Integrate Embark + Consult (if you have consult; otherwise omit)
(use-package embark-consult
  :straight t
  :after (embark consult)
  :hook (embark-collect-mode . consult-preview-at-point-mode)
  :config (message "✅ Embark-Consult integration enabled."))
#+END_SRC

** Zotero/Bibliography Integration
#+BEGIN_SRC emacs-lisp
;; -----------------------------
;; Citar Package Configuration
;; -----------------------------
(use-package citar
  :straight t
  :no-require t
  :commands (citar-insert-citation citar-create-note)
  :custom
  (org-cite-global-bibliography (list bib-path))
  (citar-bibliography org-cite-global-bibliography)
  (citar-library-paths my-citar-library-paths)
  (citar-notes-paths (list (expand-file-name "literature" org-roam-directory)))
  (citar-file-note-extensions '("org"))
  (org-cite-insert-processor 'citar)
  (org-cite-follow-processor 'citar)
  (org-cite-activate-processor 'citar)
  (citar-file-open-function 'find-file)
  :hook
  ((org-mode . citar-capf-setup)
   (LaTeX-mode . citar-capf-setup))
  :config
  (require 'citar)  ; Load full package
  (message "✅ Citar ready."))

;; Install C-c i c in org buffers only (safe)
(add-hook 'org-mode-hook
          (lambda ()
            ;; prefer local-set-key to avoid overriding global maps
            (local-set-key (kbd "C-c i c") #'citar-insert-citation)))
#+END_SRC


#+BEGIN_SRC emacs-lisp
;; Helper function to insert or create citation notes
(defun my/citar-insert-or-create-note ()
  "Insert citation if in Org-mode; otherwise, create bib note."
  (interactive)
  (if (derived-mode-p 'org-mode)
      (call-interactively 'citar-insert-citation)
    (call-interactively 'citar-create-note)))

;; Rebind your key (override the old one)
;;(global-set-key (kbd "C-c i c") 'my/citar-insert-or-create-note)
#+END_SRC

** Org noter + Citar annotation: added 2025-11-02
#+BEGIN_SRC emacs-lisp
(use-package org-noter
  :straight t
  :after (pdf-tools org)
  :config
  (setq org-noter-notes-search-path (list (expand-file-name "literature" org-roam-directory)))
  (setq org-noter-auto-save-last-location t
        org-noter-always-create-frame nil
        org-noter-highlight-selected-text t
        org-noter-insert-note-no-questions t)
  (setq org-noter-hide-other nil)
  (message "✅ Org-noter ready for PDF annotations."))
#+END_SRC

** pdf annotation using org noter
#+BEGIN_SRC emacs-lisp
(use-package org-noter-pdftools
  :straight t
  :after (org-noter pdf-tools)
  :config
  ;; Compatibility shim: convert new struct location → old (page . top) cons
  (defun my/org-noter-pdftools--convert-location (location)
    "Convert new org-noter-pdftools location struct to old (page . top) format."
    (if (consp location)
        location                                      ; already old format
      (cons (org-noter-pdftools--location-page location)
            (org-noter-pdftools--location-height location)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; -----------------------------
;; Disable org-ref to avoid conflicts if installed
;; -----------------------------
(ignore-errors (unload-feature 'org-ref t))
(straight-override-recipe '(org-ref :type built-in :local-repo nil :files nil))
(setq load-path (cl-remove-if (lambda (p) (string-match-p "org-ref" p)) load-path))
(unless (featurep 'org-ref)
  (defvar org-ref-bibliography-notes nil)
  (defvar org-ref-default-bibliography nil)
  (defvar org-ref-pdf-directory nil)
  (provide 'org-ref))
#+END_SRC

** Magit is a Git GUI interface for Emacs
#+BEGIN_SRC emacs-lisp
(use-package magit
  :straight t
  :defer t
  :commands (magit-status magit-blame)
  :init
  (global-set-key (kbd "C-x g") 'magit-status)
  :config
  (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1
        magit-save-repository-buffers 'dontask))
#+END_SRC

* ACTIVE UI Tweaks
#+BEGIN_SRC emacs-lisp
(when (eq my-device 'termux)
  (when (fboundp 'set-fringe-mode)
  (set-fringe-mode 0))
  (setq mouse-wheel-progressive-speed nil))
#+END_SRC

* ACTIVE General Settings

** Profiling
#+BEGIN_SRC emacs-lisp
(defvar my-config-el-start-time (current-time) "Time when config.el was started")
(setq my-config-el-start-time-iso (format-time-string "%Y-%m-%dT%T%:z"))
#+END_SRC

** UI Theme, word wrap and other settings.
#+BEGIN_SRC emacs-lisp
(load-theme 'tsdh-dark t)  ;;Dark theme for Emacs
(global-visual-line-mode 1) ;;Wrap text in GUI Windows
(when (fboundp 'set-fringe-mode)
  (set-fringe-mode 10)) ;;Sets the width of the left and right fringes (the empty margin space at the edge of windows in Emacs) to 10 pixels.
(setq-default cursor-type 'bar) ;;Changes the default cursor shape to a vertical bar (instead of the default box).
#+END_SRC

** Device-specific backup directory under default-directory
#+BEGIN_SRC emacs-lisp
(defvar my-backup-dir (expand-file-name ".backups/" default-directory)
  "Directory to store Emacs backup (~) files.")
#+END_SRC

** Create backup directory if it doesn't exist
#+BEGIN_SRC emacs-lisp
(unless (file-exists-p my-backup-dir)
  (make-directory my-backup-dir t))
(setq backup-directory-alist `((".*" . ,my-backup-dir))
      version-control nil
      delete-old-versions t
      make-backup-files t
      backup-by-copying t)

(defvar my-autosave-dir (expand-file-name ".autosaves/" default-directory)
  "Directory to store Emacs auto-save files.")
#+END_SRC

** Create autosave directory if missing
#+BEGIN_SRC emacs-lisp
(unless (file-exists-p my-autosave-dir)
  (make-directory my-autosave-dir t))
#+END_SRC

** Redirect auto-save files to device-specific location
#+BEGIN_SRC emacs-lisp
(setq auto-save-file-name-transforms
      `((".*" ,my-autosave-dir t))
      auto-save-default t)
#+END_SRC

** Other general settings
#+BEGIN_SRC emacs-lisp
;; Calendar: Monday as start of week
(setq-default calendar-week-start-day 1)

;; Sentences: No double space after periods
(setq-default sentence-end-double-space nil)

;; Truncate lines
(setq-default truncate-lines t)

;; Read-only files in view mode
(setq view-read-only t)

;; Timestamp functions
(defun my-insert-timestamp ()
  "Insert a timestamp in format YYYY-MM-DD HH:MM:SS"
  (interactive)
  (insert (format-time-string "%Y-%m-%d %H:%M:%S")))
(defun my-insert-datestamp ()
  "Insert a datestamp in format YYYY-MM-DD"
  (interactive)
  (insert (format-time-string "%Y-%m-%d")))
(defun my-insert-org-timestamp ()
  "Insert a timestamp in Org-mode format [YYYY-MM-DD Day HH:MM]"
  (interactive)
  (insert (format-time-string "[%Y-%m-%d %a %H:%M]")))

;; Added 2025-07-15: Allow alphabetical list continuation (1.a, 1.b, 1.c., ...)
(setq org-list-allow-alphabetical t)

;; Configure navigation between windows and automatic vertical preview for PDF.
;; Enable smart window navigation
(windmove-default-keybindings) ;; Shift + Arrow
(winner-mode 1)                ;; C-c <left/right> undo/redo window layout
#+END_SRC

** ACTIVE Org Attachment File directory
#+BEGIN_SRC emacs-lisp
;; Attachments relative to org file, in `.attach` folder
(setq org-attach-directory ".attach")
#+END_SRC

* ACTIVE Keybindings

** Tangle shortcut
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-c t") (lambda ()
  (interactive)
  (org-babel-tangle-file (expand-file-name "config.org" user-emacs-directory))
  (message "✅ config.org tangled")))
#+END_SRC

** Timestamp keybindings
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-c i t") 'my-insert-timestamp)    ;; YYYY-MM-DD HH:MM:SS
(global-set-key (kbd "C-c i d") 'my-insert-datestamp)    ;; YYYY-MM-DD
(global-set-key (kbd "C-c i g") 'my-insert-org-timestamp) ;; [YYYY-MM-DD Day HH:MM]
#+END_SRC

** Citar Citation insertion keybinding
#+BEGIN_SRC emacs-lisp
;;(global-set-key (kbd "C-c i c") 'citar-insert-citation)  ;; Insert citation with Citar
#+END_SRC

** Org-mode specific keybinding for toggling items :Added 2025-07-15
#+BEGIN_SRC emacs-lisp
(add-hook 'org-mode-hook
          (lambda ()
            (local-set-key (kbd "C-c i i") #'org-toggle-item)))
#+END_SRC

** Disble Ctrl+Z key accidental suspend-frame(minimize the window) keybinding to Undo command
#+BEGIN_SRC emacs-lisp
(global-set-key (kbd "C-z") 'undo)

;; Org capture template
(global-set-key (kbd "C-c c") 'org-capture)

;; mu4e Email integration quick access
(global-set-key (kbd "C-c m") 'mu4e)
#+END_SRC

** Switching windows 
#+BEGIN_SRC emacs-lisp
;; Ace Window for fast jumping (M-o)
(use-package ace-window
  :bind (("M-o" . ace-window)))
#+END_SRC

** ORG Agenda keybinding
#+BEGIN_SRC emacs-lisp
;;[2025-08-10] Added to ensure org-agenda is loaded and keybinding works
(require 'org-agenda)
(global-set-key (kbd "C-c a") 'org-agenda)
#+END_SRC

* ACTIVE Modular Configs
#+BEGIN_SRC emacs-lisp
(my/tangle-if-needed "org/orgxtn.org" "org/orgxtn.el")
(load (expand-file-name "org/orgxtn.el" user-emacs-directory) nil 'nomessage)

(my/tangle-if-needed "org/roam.org" "org/roam.el")
(load (expand-file-name "org/roam.el" user-emacs-directory) nil 'nomessage)

(my/tangle-if-needed "org/filetags.org" "org/filetags.el")
(load (expand-file-name "org/filetags.el" user-emacs-directory) nil 'nomessage)

(my/tangle-if-needed "org/workflow.org" "org/workflow.el")
(load (expand-file-name "org/workflow.el" user-emacs-directory) nil 'nomessage)

;; note and annotation configuaration
(my/tangle-if-needed "org/notextn.org" "org/notextn.el")
(load (expand-file-name "org/notextn.el" user-emacs-directory) nil 'nomessage)

;;General LaTeX export configs (requires TeX Live, latexmk)
(my/tangle-if-needed "org/latextn.org" "org/latextn.el")
(load (expand-file-name "org/latextn.el" user-emacs-directory) nil 'nomessage)

;; Optional: Engineering-specific configs for TikZ/CircuitTikZ diagrams. Comment the engxtn.el if you dont use engineering settings.
(my/tangle-if-needed "org/engxtn.org" "org/engxtn.el")
(load (expand-file-name "org/engxtn.el" user-emacs-directory) nil 'nomessage)

(when (eq my-device 'laptop)
(my/tangle-if-needed "org/mail.org" "org/mail.el")
(load (expand-file-name "org/mail.el" user-emacs-directory) nil 'nomessage))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun my-tangle-all ()
  "Tangle all modular Org files."
  (interactive)
  (my/tangle-if-needed "org/orgxtn.org" "org/orgxtn.el")
  (my/tangle-if-needed "org/roam.org" "org/roam.el")
  (my/tangle-if-needed "org/filetags.org" "org/filetags.el")
  (my/tangle-if-needed "org/workflow.org" "org/workflow.el")
  (my/tangle-if-needed "org/notextn.org" "org/notextn.el")
  (my/tangle-if-needed "org/latextn.org" "org/latextn.el")
  ;; if dont want engineering specific org extension. comment following engxtn.el
  (my/tangle-if-needed "org/engxtn.org" "org/engxtn.el")
      (when (eq my-device 'laptop)
  (my/tangle-if-needed "org/mail.org" "org/mail.el"))
  ;; Add more modular files here (e.g., workflows.org when uncommented)
  (message "[%s] All modular files tangled" (format-time-string "%T")))
(global-set-key (kbd "C-c T") 'my-tangle-all)
#+END_SRC


* Git enabled org notes sync with repo
Note: If you are not using git source control for org notes across devices, comment/remove following function

#+BEGIN_SRC emacs-lisp
;; Magit-based Git for Org notes sync
;; Assumes repo is on 'main' branch with 'origin' remote; customize as needed

;; Manual pull function (replaces git-pull-repo)
(defun magit-pull-org-repo ()
  "Pull the Org notes repo using Magit (async)."
  (interactive)
  (magit-pull-from-upstream nil) ; Pulls from origin/main; nil for default args
  (message "Magit pull started (check Magit process buffer if needed)."))

;; Manual push function (replaces git-push-repo)
(defun magit-push-org-repo ()
  "Stage modified files, commit if needed (with prompt), then push using Magit (async)."
  (interactive)
  (magit-stage-modified) ; Stages only tracked/modified files (safer than git add -A)
  (when (magit-anything-staged-p) ; Only commit if there are changes
    (magit-commit-create)) ; Interactive commit with message prompt
  (magit-push-current-to-upstream nil) ; Pushes to origin/main
  (message "Magit push started (check Magit process buffer if needed)."))

;; C-c g p for pull, C-c g u for push
(defvar git-org-map (make-sparse-keymap) "Keymap for Git Org commands.")
(define-key global-map (kbd "C-c g") git-org-map)
(define-key git-org-map (kbd "p") 'magit-pull-org-repo)
(define-key git-org-map (kbd "u") 'magit-push-org-repo)
#+END_SRC


* CANCELLED Deprecated Settings
#+BEGIN_SRC emacs-lisp
;; Old timestamp code for Emacs < 27.1
;; (setq my-config-el-start-time-iso
;;       (concat (format-time-string "%Y-%m-%dT%T")
;;               ((lambda (x) (concat (substring x 0 3) ":" (substring x 3 5)))
;;                (format-time-string "%z"))))
#+END_SRC
