#+TITLE: Engineering-Specific Org Extensions Configuration
#+TODO: ACTIVE | CANCELLED
#+STARTUP: indent
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+DATE: 2025-10-04
#+CREATED: [%<%Y-%m-%d %a %H:%M>]
#+LAST_MODIFIED: [%<%Y-%m-%d %a %H:%M>]

This file contains configurations for VLSI-specific Org-mode features, primarily for TikZ and CircuitTikZ diagrams used in circuit design. It is optional and should only be loaded by users who need these features. Dependencies: TeX Live (with tikz, circuitikz), ImageMagick, Ghostscript, ditaa.jar. Tangled to ~org/customxtn.el~ and loaded via ~config.org~ (uncomment the load if needed).

* ACTIVE VLSI Diagram Support
#+BEGIN_SRC emacs-lisp

;; --------------------------------------------
;; Automatic org latex preview. If you dont require diable by commenting
;; -------------------------------------------

;; Enable automatic preview of LaTeX fragments when opening an Org buffer
;; (setq org-startup-with-latex-preview t)

;; Use your chosen process (recommended: pdftoppm for LuaLaTeX)
(setq org-preview-latex-default-process 'pdftoppm)

;; -----------------------------------------------------------------------------------------------------------
;; Custom Latex make commands for latex-compiler in Image converter selection and org-preview-latex-process-alist
;; -------------------------------------------------------------------------------------------------------------

(defun my/org-latex-make-latex-cmd (engine)
  "Return a latex command template using ENGINE for org-preview (no latexmk here).
   engine -interaction=nonstopmode -halt-on-error -output-directory=%o %f"
   ;; Fallback prevents nil errors
  (format "%s -interaction=nonstopmode -halt-on-error -output-directory=%%o %%f" (or engine "lualatex")))  

;; --------------------------------------------
;; Choose the compiler. Default modern lualatex or pdflatex as Fallback
;; -------------------------------------------

;; Remove inputenc from default packages for all LaTeX exports (safe for pdfLaTeX/LuaTeX/XeTeX)
(setq org-latex-default-packages-alist
      (delete '("AUTO" "inputenc" t) org-latex-default-packages-alist))  

;; Ensure AUCTeX preview uses LuaLaTeX
(setq preview-LaTeX-command
      '("%`%l -interaction=nonstopmode -halt-on-error -output-directory=%o %t"))
(setq preview-dvips-command "dvips -Ppdf -q -f %d -o %m/preview.ps") 

;; Choose engine (call interactively if you want)
(defun my/org-use-lualatex () (interactive) (setq my/org-latex-engine "lualatex"))
(defun my/org-use-pdflatex () (interactive) (setq my/org-latex-engine "pdflatex"))

;; --------------------------------------------
;; Choose the compiler. Default modern lualatex or pdflatex as Fallback
;; -------------------------------------------


;; Make sure Emacs has the TeX binaries on its exec-path before running preview
(dolist (d '("/usr/local/texlive/2025/bin/x86_64-linux" "/usr/bin" "/usr/local/bin"))
  (when (and (stringp d) (file-directory-p d) (not (member d exec-path)))
    (add-to-list 'exec-path d)))
(setenv "PATH" (concat (mapconcat 'identity exec-path ":") ":" (or (getenv "PATH") "")))

;; ---------------------------
;; IMPORTANT: preview preamble (NO \\begin{document}, only packages + preview directives)
;; ---------------------------
(setq org-format-latex-header
"\\documentclass[varwidth=true,border=0pt]{standalone}
\\usepackage{fontspec}
\\usepackage{amsmath,mathtools}
\\usepackage{xcolor}
\\usepackage{siunitx}
\\usepackage{tikz}
\\usepackage[american]{circuitikz}

% preview: active, tightpage; latexmath lets preview capture inline/display math when they are separate blocks
\\usepackage[active,tightpage,displaymath,latexmath]{preview}
\\setlength\\PreviewBorder{0pt}

% Environments to crop tightly
\\PreviewEnvironment{math}        % inline math when it is its own paragraph / block
\\PreviewEnvironment{displaymath}
\\PreviewEnvironment{equation}
\\PreviewEnvironment{equation*}
\\PreviewEnvironment{align}
\\PreviewEnvironment{align*}
\\PreviewEnvironment{tikzpicture}
\\PreviewEnvironment{circuitikz}

% Use unique color names (avoid collision with any \"fg/bg\" inserted later)
\\definecolor{orgfg}{rgb}{1,1,1}          % pure white text
\\definecolor{orgbg}{rgb}{0.2,0.2,0.2}    % dark background

% Apply the unique colors for previews
% Use AtBeginDocument so it runs when document starts
\\AtBeginDocument{\\pagecolor{orgbg}\\color{orgfg}}


% Helper macro: wrap expression in \\pv{...} to force a preview box around it.
% Usage: \\pv{\\( E = mc^2 \\)} or \\pv{$E=mc^2$}
\\newcommand{\\pv}[1]{\\begin{preview}#1\\end{preview}}

% Reduce incidental spacing
\\mathsurround=0pt
\\setlength\\abovedisplayskip{0pt}
\\setlength\\belowdisplayskip{0pt}
\\setlength\\parindent{0pt}
")


;; ---------------------------
;;Initialize and set appearance options
;; ---------------------------

;; Initialize and set appearance options
(unless (boundp 'org-latex-preview-appearance-options)
  (setq org-latex-preview-appearance-options (list)))
(setq org-latex-preview-appearance-options
  (plist-put org-latex-preview-appearance-options :page-width 0.8)) ; Narrower page
(setq org-format-latex-options
  (plist-put (or org-format-latex-options (list)) :scale 1)) ; Default scale
;; ---------------------------
;; Image converter selection and org-preview-latex-process-alist
;; ---------------------------
;; Prefer pdftoppm (poppler) because it produces the single-file PNG reliably.
(let* ((engine (or (and (boundp 'my/org-latex-engine) my/org-latex-engine) "lualatex"))
       (pdftoppm (executable-find "pdftoppm"))
       (magick   (or (executable-find "magick") (executable-find "convert")))
       (ghostscript (executable-find "gs"))
       process-entry)
  (cond
   (pdftoppm
    (setq process-entry
          (list 'imagemagick
                :programs (list engine "pdftoppm")
                :description (format "%s -> pdf -> pdftoppm -> png" engine)
                :message (format "Requires %s + pdftoppm." engine)
                :image-input-type "pdf"
                :image-output-type "png"
                ;; latex-compiler must be a list of *one* string (Org will call it)
                :latex-compiler (list (my/org-latex-make-latex-cmd engine))
                ;; image-converter should be a list for execvp; here we use a shell wrapper
                ;; NOTE: use -singlefile so pdftoppm produces a known basename "%o-1.png" or "%o.png"
                :image-converter (list "sh" "-c" (concat "pdftoppm -png -singlefile -r %D %f %o && "
                    "if [ -f \"%o-1.png\" ]; then convert \"%o-1.png\" -trim \"%O\"; "
                    "elif [ -f \"%o.png\" ]; then convert \"%o.png\" -trim \"%O\"; "
                    "else echo \"pdftoppm produced no expected file\" 1>&2; exit 2; fi")))))
   ((and magick ghostscript)
    (setq process-entry
          (list 'imagemagick
                :programs (list engine (file-name-nondirectory magick))
                :description (format "%s -> pdf -> %s -> png" engine (file-name-nondirectory magick))
                :message (format "Requires %s + %s." engine (file-name-nondirectory magick))
                :image-input-type "pdf"
                :image-output-type "png"
                :latex-compiler (list (my/org-latex-make-latex-cmd engine))
                ;; use convert/magick as list of args
                :image-converter (list magick "-density" "%D" "%f" "-trim" "-flatten" "%O"))))
          (magick
           (message "Warning: Ghostscript (gs) not found; ImageMagick may fail to process PDFs.")))
  (when process-entry
    (setq org-preview-latex-default-process 'imagemagick)
    ;; assign a proper alist (Org expects an alist; using (list process-entry) is correct)
    (setq org-preview-latex-process-alist (list process-entry))
    ;; older variable name sync if needed
    (when (boundp 'org-latex-preview-process-alist)
      (setq org-latex-preview-process-alist org-preview-latex-process-alist))
    (message "Org preview pipeline installed using %s" (if pdftoppm "pdftoppm" (file-name-nondirectory magick))))
  (unless process-entry
    (message "Warning: neither pdftoppm nor ImageMagick (magick/convert) found; cannot preview LaTeX.")))
#+END_SRC

* ACTIVE Mathpix's OCR capabilities
#+BEGIN_SRC emacs-lisp
(use-package mathpix
  :straight (:host github :repo "jethrokuan/mathpix.el")
  :defer t  ; Load lazily to avoid startup overhead
  :custom
  (mathpix-app-id "YOUR_MATHPIX_APP_ID")  ; From mathpix.com dashboard
  (mathpix-app-key "YOUR_MATHPIX_APP_KEY")
  (mathpix-screenshot-method "scrot -s %s")  ; Requires scrot installed (sudo apt install scrot on Ubuntu)
  :bind ("C-c x" . mathpix-screenshot)  ; Distinct from org-noter keys
  :config
  ;; Optional: Add a hook to clean up after OCR if needed
  (add-hook 'mathpix-after-insert-hook (lambda () (org-latex-preview)))  ; Auto-preview inserted LaTeX in Org
  )
#+END_SRC

** Custom function: annotation with Org Noter 
#+BEGIN_SRC emacs-lisp
;; --- Key function: open note & PDF side-by-side, prepare for annotation ---
(defun my/open-paper-and-note ()
  "Open the PDF and org-roam note linked to a citation key.
Select the citation key via `citar-select-ref`. Open the associated PDF in the right window,
and open or create the corresponding org note. Set `NOTER_DOCUMENT` property in the note.
Start `org-noter` for annotation if available."
  (interactive)
  (require 'citar)
  (require 'org-noter)
  (let* ((key (citar-select-ref))
         (entry (when key (citar-get-entry key)))
         (files (ignore-errors (citar-get-files key)))
         (pdf (my/citar-extract-first-path files))
         (title (when entry (or (cdr (assoc "title" entry)) key)))
         (note-file (expand-file-name (concat key ".org")
                                     (expand-file-name "literature" org-roam-directory))))
    (unless (file-directory-p (file-name-directory note-file))
      (make-directory (file-name-directory note-file) t))
    (delete-other-windows)
    (if pdf
        (progn (split-window-right)
               (find-file pdf)
               (when (fboundp 'pdf-view-fit-page-to-window)
                 (pdf-view-fit-page-to-window))
               (other-window 1))
      (message "No PDF found for citekey: %s" key))
    (unless (file-exists-p note-file)
      (find-file note-file)
      (let ((id (org-id-new)))
        (insert (format "#+TITLE: %s\n#+ROAM_REFS: cite:%s\n:PROPERTIES:\n:ID: %s\n:NOTER_DOCUMENT: %s\n:END:\n\n* Overview\n\n* Annotations\n\n* Bib Entry\n[cite:@%s]\n"
                        title key id (or pdf "") key))
        (save-buffer)))
    (find-file note-file)
    (save-excursion
      (goto-char (point-min))
      (unless (re-search-forward ":NOTER_DOCUMENT:" nil t)
        (when pdf
          (re-search-forward ":END:" nil t)
          (insert (format "\n:NOTER_DOCUMENT: %s" pdf))
          (save-buffer))))
    (when (and (featurep 'org-noter) pdf)
      (org-noter))))

(global-set-key (kbd "C-c i a") #'my/open-paper-and-note)
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ---------------------------
;; Consolidated: Citar + Org-Noter annotation capture
;; ---------------------------

(require 'citar)
(require 'org-noter)

(defvar my/last-citar-note nil
  "Path to the last bib note opened by `my/annotate-bib-pdf`.")

(defvar my/last-citar-pdf nil
  "Path to the last PDF opened by `my/annotate-bib-pdf`.")

(defvar my/last-citar-key nil
  "Citekey last used with `my/annotate-bib-pdf`.")
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; -----------------------------
;; Refined: Open PDF and Note Side-by-Side for Annotation
;; -----------------------------
(defun my/citar-extract-first-path (x)
  "Recursively extract first string path from X, or nil."
  (cond
   ((null x) nil)
   ((stringp x) x)
   ((hash-table-p x)
    (let (found)
      (maphash (lambda (_k v)
                 (unless found
                   (setq found (my/citar-extract-first-path v))))
               x)
      found))
   ((vectorp x) (and (> (length x) 0) (my/citar-extract-first-path (aref x 0))))
   ((listp x) (my/citar-extract-first-path (car x)))
   (t nil)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun my/open-paper-and-note ()
  "Open PDF & org-roam note for a bib entry, always setting NOTER_DOCUMENT to absolute path.
Select cite key, open PDF in right window, open or create org note with citation metadata,
and start org-noter if possible."
  (interactive)
  (require 'citar)
  (require 'org-noter)
  (let* ((key (citar-select-ref))
         (entry (when key (citar-get-entry key)))
         (files (ignore-errors (citar-get-files key)))
         (pdf (when files (expand-file-name (my/citar-extract-first-path files))))
         (title (when entry (or (cdr (assoc "title" entry)) key)))
         (note-file (expand-file-name (concat key ".org")
                                     (expand-file-name "literature" org-roam-directory))))
    (unless (file-directory-p (file-name-directory note-file))
      (make-directory (file-name-directory note-file) t))
    ;; Window management: split only if one window; otherwise preserve layout
    (when (= (length (window-list)) 1)
      (split-window-right))
    (if pdf
        (progn
          (find-file pdf)
          (when (fboundp 'pdf-view-fit-page-to-window)
            (pdf-view-fit-page-to-window))
          (other-window 1))
      (message "No PDF found for citekey: %s" key))
    (unless (file-exists-p note-file)
      (find-file note-file)
      (let ((id (org-id-new)))
        (insert (format "#+TITLE: %s\n#+ROAM_REFS: cite:%s\n:PROPERTIES:\n:ID: %s\n:NOTER_DOCUMENT: %s\n:END:\n\n* Overview\n\n* Annotations\n\n* Bib Entry\n[cite:@%s]\n"
                        title key id (or pdf "") key))
        (save-buffer)))
    (find-file note-file)
    (save-excursion
      (goto-char (point-min))
      (unless (re-search-forward ":NOTER_DOCUMENT:" nil t)
        (when pdf
          (re-search-forward ":END:" nil t)
          (insert (format "\n:NOTER_DOCUMENT: %s" pdf))
          (save-buffer))))
    (when (and (featurep 'org-noter) pdf)
      (org-noter))))

(global-set-key (kbd "C-c i a") #'my/open-paper-and-note)

#+END_SRC

#+BEGIN_SRC emacs-lisp
; -----------------------------
;; Insert PDF Selection to Note
;; -----------------------------
(defun my/citar-find-note-file-for-key (key)
  "Return first org-roam note file that matches KEY in citar-notes-paths or org-roam-directory."
  (let* ((dirs (or (and (boundp 'citar-notes-paths) citar-notes-paths)
                   (and (boundp 'org-roam-directory) (list org-roam-directory))
                   (list default-directory)))
         (pattern (concat (regexp-quote key) ".*\\.org\\'"))
         (found nil))
    (dolist (d dirs found)
      (when (and (stringp d) (file-directory-p d) (not found))
        (let ((res (ignore-errors (directory-files-recursively d pattern 1))))
          (when (and res (> (length res) 0))
            (setq found (car res))))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
; -----------------------------
;; Insert PDF Selection to Note
;; -----------------------------
(defun my/pdf-insert-selection-to-note ()
  "Insert selected PDF text or note to current bib note under Annotations."
  (interactive)
  (let* ((selection (ignore-errors (pdf-view-active-region-text)))
         (page (ignore-errors (when (fboundp 'pdf-view-current-page) (pdf-view-current-page))))
         (time (format-time-string "%Y-%m-%d %H:%M"))
         (note-buf (my/citar-find-note-file-for-key my/last-citar-key)))
    (unless (and note-buf (buffer-live-p (get-file-buffer note-buf)))
      (user-error "Could not find or open a bib note buffer. Run C-c i a first."))
    (with-current-buffer note-buf
      (goto-char (point-min))
      (if (re-search-forward "^\\*+ Annotations" nil t)
          (goto-char (match-end 0))
        (goto-char (point-max))
        (unless (bolp) (insert "\n"))
        (insert "* Annotations\n\n"))
      (let ((heading (format "** Page %s â€” %s\n" (or page "-") time)))
        (insert heading)
        (when page
          (insert ":PROPERTIES:\n")
          (insert (format ":NOTER_PAGE: %s\n" page))
          (insert ":END:\n\n"))
        (when (and selection (not (string-blank-p selection)))
          (insert (format "%s\n\n" selection))
          (save-buffer))))
    (message "Inserted selection into %s (page %s)" note-buf (or page "-"))))

(define-key pdf-view-mode-map (kbd "C-c i p") #'my/pdf-insert-selection-to-note)
#+END_SRC
