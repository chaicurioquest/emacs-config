#+TITLE: Central Keymaps
#+TODO: ACTIVE | CANCELLED
#+STARTUP: indent
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+DATE: 2025-10-20
#+CREATED: %U
#+LAST_MODIFIED: [%<%Y-%m-%d %a %H:%M>]

* Keymaps and global bindings
This file centralises prefix maps and global keybindings.
It assumes the corresponding commands (functions) are defined in other modules
(e.g. config.el, orgxtn.el, notextn.el, roam.el, etc.).

#+BEGIN_SRC emacs-lisp
;;; keymaps.el --- Central keymaps and global bindings  -*- lexical-binding: t; -*-

;; ─────────────────────────────────────────────────────────────
;; Prefix keymaps (no quote — bind the keymap value itself)
;; ─────────────────────────────────────────────────────────────
(defvar my/citar-map (make-sparse-keymap)
  "Prefix C-c i → citations, literature notes, timestamps, PDF tools.")
(global-set-key (kbd "C-c i") my/citar-map)

(defvar my/roam-map (make-sparse-keymap)
  "Prefix C-c r → pure Org-roam navigation & dailies.")
(global-set-key (kbd "C-c r") my/roam-map)

(defvar git-org-map (make-sparse-keymap)
  "Prefix C-c g → Git operations on Org notes.")
(global-set-key (kbd "C-c g") git-org-map)

;; ─────────────────────────────────────────────────────────────
;; Global single-key bindings
;; ─────────────────────────────────────────────────────────────
(global-set-key (kbd "C-c t") #'my-tangle-config-org)
(global-set-key (kbd "C-c T") #'my-tangle-all)
(global-set-key (kbd "C-c c") #'org-capture)
(global-set-key (kbd "C-c a") #'org-agenda)
(global-set-key (kbd "C-c v") #'my/org-pdf-vertical-view)
(global-set-key (kbd "C-c f t") #'my-org-set-filetags)
(global-set-key (kbd "C-x g") #'magit-status)
(global-set-key (kbd "C-c m") #'mu4e)
(global-set-key (kbd "C-z") #'undo)
(global-set-key (kbd "M-o") #'ace-window)

;; ─────────────────────────────────────────────────────────────
;; C-c i → Everything citation & literature related
;; ─────────────────────────────────────────────────────────────
;; Timestamps
(define-key my/citar-map (kbd "t") #'my-insert-timestamp)
(define-key my/citar-map (kbd "d") #'my-insert-datestamp)
(define-key my/citar-map (kbd "o") #'my-insert-org-timestamp)

;; Core Citar actions
(with-eval-after-load 'citar
  (define-key my/citar-map (kbd "c")   #'citar-insert-citation)   ; C-c i c
  (define-key my/citar-map (kbd "C")   #'citar-insert-citation)   ; same with Shift
  (define-key my/citar-map (kbd "r")   #'citar-insert-reference)
  (define-key my/citar-map (kbd "k")   #'citar-insert-keys)

  ;; Literature notes workflow — now lives under C-c i 
  (define-key my/citar-map (kbd "n")   #'citar-create-note)      ; C-c i n → new blank note
  (define-key my/citar-map (kbd "N")   #'citar-open-note)        ; C-c i N → open/create note at point
  (define-key my/citar-map (kbd "C-n") #'citar-open-notes)       ; C-c i C-n → pick any entry → open note
  (define-key my/citar-map (kbd "o")   #'citar-open)             ; C-c i o → open PDF/link/etc.
  (define-key my/citar-map (kbd "O")   #'citar-open-files))      ; C-c i O → open all files

;; PDF annotation helpers (Custom functions)
(with-eval-after-load 'org-noter
  (define-key my/citar-map (kbd "a") #'my/open-pdf-and-note)
  (define-key my/citar-map (kbd "g") (lambda () (interactive) (my/open-pdf-and-note 'generic)))
  (define-key my/citar-map (kbd "p") #'my/pdf-insert-selection-to-note)
  (define-key my/citar-map (kbd "A") #'org-noter-pdftools-insert-annotations))

(with-eval-after-load 'pdf-view
  (define-key pdf-view-mode-map (kbd "C-c i s") #'my/save-pdf-region-to-datestamp)
  (define-key pdf-view-mode-map (kbd "C-c i S") (lambda () (interactive) (my/save-pdf-region-to-datestamp t))))

(when (eq my-device 'laptop)
  (with-eval-after-load 'calibredb
    (define-key my/citar-map (kbd "b") #'my/open-calibre-book-and-note)))

;; ─────────────────────────────────────────────────────────────
;; C-c r → Pure Org-roam navigation (no citar clutter)
;; ─────────────────────────────────────────────────────────────
(with-eval-after-load 'org-roam
  (define-key my/roam-map (kbd "f") #'org-roam-node-find)
  (define-key my/roam-map (kbd "i") #'org-roam-node-insert)
  (define-key my/roam-map (kbd "n") #'org-roam-capture)
  (define-key my/roam-map (kbd "d") #'org-roam-dailies-capture-today)
  (define-key my/roam-map (kbd "T") #'org-roam-dailies-goto-today)
  (define-key my/roam-map (kbd "P") #'org-roam-dailies-goto-previous-note)
  (define-key my/roam-map (kbd "N") #'org-roam-dailies-goto-next-note)
  (define-key my/roam-map (kbd "D") #'org-roam-dailies-goto-date)
  (define-key my/roam-map (kbd "t") #'my-org-roam-tag-add)
  (define-key my/roam-map (kbd "r") #'my-org-roam-tag-remove)
  (define-key my/roam-map (kbd "s") #'my/org-roam-safe-rebuild)

  (when (eq my-device 'laptop)
    (define-key my/roam-map (kbd "g") #'org-roam-ui-open)))

;; ─────────────────────────────────────────────────────────────
;; C-c g → Git for Org notes
;; ─────────────────────────────────────────────────────────────
(define-key git-org-map (kbd "p") #'magit-pull-org-repo)
(define-key git-org-map (kbd "u") #'magit-push-org-repo)

;; ─────────────────────────────────────────────────────────────
;; Org-mode local overrides
;; ─────────────────────────────────────────────────────────────
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "TAB") #'my/org-smart-tab)
  (define-key org-mode-map (kbd "C-c i i") #'org-toggle-item))

(with-eval-after-load 'mu4e-view
  (define-key mu4e-view-mode-map (kbd "C-c C-c") #'mu4e-org-store-and-capture))

(provide 'keymaps)
;;; keymaps.el ends here
#+END_SRC