#+TITLE: General LaTeX Export Configuration
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+DATE: [%<%Y-%m-%d>]

* LaTeX export & preview configuration
#+BEGIN_SRC emacs-lisp
;; ------------------------------
;; setup-latex.org
;; Default engine: LuaLaTeX
;; pdfLaTeX kept as standby for compatibility
;; ------------------------------

(require 'oc)
(require 'oc-biblatex)

;; Prefer LuaLaTeX for export & Babel execution
;;(defvar my/org-latex-engine "lualatex"
;;  "Default LaTeX engine for Org export. Change to \"pdflatex\" only when needed.")
  
(setq org-latex-compiler "lualatex")  ; Hardcode to avoid nil
(setq org-babel-latex-compiler "lualatex")  ; Hardcode to avoid nil

;; Remove inputenc and fontenc with exact match (fourth element is engine list)
(setq org-latex-default-packages-alist
      (delete '("AUTO" "inputenc" t ("pdflatex"))
              (delete '("T1" "fontenc" t ("pdflatex")) org-latex-default-packages-alist)))

;; Add fontspec for LuaTeX
(add-to-list 'org-latex-default-packages-alist '("" "fontspec" t) t)

;; Show previews only when you ask (change to t to enable automatically)
;; (setq org-startup-with-latex-preview t)
;; (setq org-preview-latex-default-process 'imagemagick)

;; Tweak preview scale and other options
;; (setq org-format-latex-options
;;      (plist-put org-format-latex-options :scale 1.1)) ;; 1.0–1.3 typical

;; Set TEXINPUTS to include subdirs under root for LaTeX inputs
(setenv "TEXINPUTS" (concat
                     (file-name-as-directory default-directory) "latex:"
                     (file-name-as-directory default-directory) "images:"
                     (getenv "TEXINPUTS")))

;; Set BIBINPUTS to include bib/ under root for bibliography files
(setenv "BIBINPUTS" (concat
                     (file-name-as-directory default-directory) "bib:"
                     (getenv "BIBINPUTS")))

;; Define LaTeX-to-PDF export commands using latexmk
(let ((latexmkrc (expand-file-name ".latexmkrc" (file-name-directory setupfile))))
  (setq org-latex-pdf-process
        `(,(format "mkdir -p %%o/build && latexmk -lualatex -r %s -outdir=%%o/build -f %%f" latexmkrc)
          "cp %o/build/%b.pdf %o/%b.pdf"
          "find %o/build -type f ! -name '*.log' -delete")))


;; Warn if setup-latex.org is missing
(let ((setup-file setupfile))
  (unless (file-exists-p setup-file)
    (message "⚠️ Org LaTeX setup file not found: %s" setup-file)))

#+END_SRC
