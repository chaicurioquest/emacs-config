#+TITLE: Bibliography and Org-Noter Integration
#+TODO: ACTIVE | CANCELLED
#+STARTUP: indent
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+DATE: 2025-10-20
#+CREATED: %U
#+LAST_MODIFIED: [%<%Y-%m-%d %a %H:%M>]

This file provides a clean, minimal, and robust integration between:
- Citar
- Org-roam
- PDF Tools
- Org-Noter

It handles both bibliography notes and generic PDFs (books, whitepapers, etc.)
with a unified command set under =C-c i=.

* Core Functions
#+BEGIN_SRC emacs-lisp
;;; notextn.el --- Org-noter + Citar + PDF Tools integration -*- lexical-binding: t; -*-
;; Required packages
(require 'org)
(require 'org-id)
(require 'org-noter)
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Fix "wrong-type-argument listp t" from image-mode-winprops
;; ──────────────────────────────────────────────────────────────
(defun my/proper-list-p (obj)
  "Return t if OBJ is a proper list (nil-terminated, no cycles or dots)."
  (and (listp obj)
       (catch 'improper
         (while (consp obj)
           (setq obj (cdr obj))
           (unless (or (consp obj) (null obj))
             (throw 'improper nil)))
         (null obj))))
(defun my/sanitize-image-winprops-in-doc-window (orig &rest args)
  "Initialize image-mode-winprops-alist in the Org-noter document window before calling ORIG."
  (let ((doc-win (org-noter--get-doc-window)))
    (when (and doc-win (window-live-p doc-win))
      (with-selected-window doc-win
        (image-mode-setup-winprops))))
  (apply orig args))
(with-eval-after-load 'org-noter
  (advice-add 'org-noter--doc-approx-location :around #'my/sanitize-image-winprops-in-doc-window))
(add-hook 'pdf-view-mode-hook #'image-mode-setup-winprops)
(add-hook 'image-mode-hook #'image-mode-setup-winprops)
;; ──────────────────────────────────────────────────────────────
;; Fix "wrong-type-argument listp #s(org-noter-pdftools--location ...)"
;; ──────────────────────────────────────────────────────────────
(with-eval-after-load 'org-noter-pdftools
  (defun my/org-noter-convert-location-to-cons (loc)
    "Convert LOC (struct or cons) to (page . top) cons."
    (cond
     ((consp loc) loc) ; Already cons
     ((org-noter-pdftools--location-p loc)
      (cons (org-noter-pdftools--location-page loc)
            (org-noter-pdftools--location-height loc)))
     (t (error "Invalid location type: %S" (type-of loc)))))
  (advice-add 'org-noter--pretty-print-location-for-title :around
              (lambda (orig loc &rest args)
                (let ((converted-loc (my/org-noter-convert-location-to-cons loc)))
                  (apply orig converted-loc args)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package org-pdfview
  :straight t
  :after (org pdf-view)
  :config
  (add-to-list 'org-modules 'org-pdfview)
  (org-link-set-parameters "pdf"
                           :follow #'org-pdfview-open
                           :export #'org-pdfview-export))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Org-noter settings
;; ──────────────────────────────────────────────────────────────
(setq org-noter-notes-search-path
      (list (expand-file-name "literature" org-roam-directory))
      org-noter-default-notes-file-names '("notes.org" "annotations.org")
      org-noter-auto-save-last-location t
      org-noter-highlight-selected-text nil
      org-noter-insert-note-no-questions t
      org-noter-hide-other nil)
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Helper: first PDF path from Citar
;; ──────────────────────────────────────────────────────────────
(defun my/citar-extract-first-path (x)
  "Return first string path in X or nil."
  (cond ((null x) nil)
        ((stringp x) x)
        ((vectorp x) (when (> (length x) 0) (my/citar-extract-first-path (aref x 0))))
        ((listp x) (my/citar-extract-first-path (car x)))
        ((hash-table-p x) (let (found)
                           (maphash (lambda (_ v)
                                      (unless found (setq found (my/citar-extract-first-path v))))
                                    x)
                           found))
        (t nil)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Normalize note file
;; ──────────────────────────────────────────────────────────────
(defun my/bibnote-normalize-file (note-file &optional pdf title)
  "Ensure note file has proper structure and properties."
  (let ((buf (find-file-noselect note-file)))
    (with-current-buffer buf
      (save-excursion
        (goto-char (point-min))
        (unless (re-search-forward "^\\*\\s-+\\S-" nil t)
          (goto-char (point-max))
          (insert (format "* %s\n\n" (or title "Overview"))))
        (goto-char (point-min))
        (re-search-forward "^\\*\\s-+\\S-")
        (unless (org-entry-get (point) "ID") (org-id-get-create))
        (when pdf
          (org-entry-put (point) "NOTER_DOCUMENT" (expand-file-name pdf)))
        (goto-char (point-min))
        (unless (re-search-forward "^\\*+\\s-+Analysis and Inference\\b" nil t)
          (goto-char (point-max))
          (unless (bolp) (insert "\n"))
          (insert "* Analysis and Inference\n\n")))
      (when (buffer-modified-p) (save-buffer))))
  note-file)
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Templates & helpers(no dead Bib Entry)
;; ──────────────────────────────────────────────────────────────
(defun my/load-template (filename)
  "Load template or return clean fallback."
  (let ((path (expand-file-name filename (expand-file-name "template" user-emacs-directory))))
    (if (file-exists-p path)
        (with-temp-buffer (insert-file-contents path) (buffer-string))
      (message "Template %s not found; using fallback." path)
      "#+TITLE: %s\n#+ROAM_ALIASES: %s\n#+ROAM_REFS: cite:%s\n* Overview\n:PROPERTIES:\n:AUTHOR: %s\n:DOI: %s\n:YEAR: %s\n:NOTER_DOCUMENT: %s\n:ID: %s\n:END:\n* Analysis and Inference\n")))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Bibliography note template
;; ──────────────────────────────────────────────────────────────
(defun my/load-roam-bib-template (&optional citekey title)
  "Generate bibliography note from Citar entry."
  (let* ((template (my/load-template "roam-bib.org"))
         (citekey (or citekey (plist-get org-roam-capture--info 'citar-citekey) ""))
         (entry (ignore-errors (when citekey (citar-get-entry citekey))))
         (title (or title (plist-get org-roam-capture--info 'title)
                    (and entry (cdr (assoc "title" entry))) "Untitled"))
         (author (or (and entry (cdr (assoc "author" entry))) ""))
         (doi (or (and entry (cdr (assoc "doi" entry))) ""))
         (date (or (and entry (cdr (assoc "date" entry))) ""))
         (year (or (and entry (cdr (assoc "year" entry)))
                   (and (> (length date) 3) (substring date 0 4)) ""))
         (file (or (ignore-errors (my/citar-extract-first-path (citar-get-files citekey))) ""))
         (noter-document (if (string-empty-p file) "" file))
         (id (org-id-new)))
    (format template title citekey citekey author doi year noter-document id)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; Select pdf from Org default directory or any folder
(defun my/select-pdf-project-or-browse ()
  "Select PDF project-wide (recursive, includes .attach) or browse any location manually."
  (interactive)
  (let* ((root (read-directory-name "Project root directory: " default-directory))
         (find-cmd (format "find %s \\( -type f -o -type l \\) -name '*.pdf'" root))
         (pdf-list (split-string (shell-command-to-string find-cmd) "\n" t))
         (choice (completing-read "Select project PDF (or type * for browser): "
                                  (append pdf-list '("* Browse anywhere...")) nil t)))
    (if (string= choice "* Browse anywhere...")
        (read-file-name "Select any file: " nil nil t)
      choice)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Unified opener
;; ──────────────────────────────────────────────────────────────
(defun my/open-pdf-and-note (&optional key-or-pdf)
  "Open PDF and note. Use 'generic for non-bib files."
  (interactive)
  (require 'citar nil t)
  (let* ((is-bib (not (eq key-or-pdf 'generic)))
         (key (if is-bib
                  (substring (or key-or-pdf (concat "@" (citar-select-ref))) 1)
                nil))
         ;; Use robust selector for generic PDFs
         (pdf-raw (if is-bib
                      (my/citar-extract-first-path (citar-get-files key))
                    (my/select-pdf-project-or-browse)))
         ;; Defensive conversion: buffer or string to path
         (pdf (cond
               ((bufferp pdf-raw) (buffer-file-name pdf-raw))
               ((stringp pdf-raw) pdf-raw)
               (t (user-error "PDF selection did not yield a valid path or buffer."))))
         (entry (when is-bib (ignore-errors (citar-get-entry key))))
         ;; Defensive: only use file-name-base if pdf is a string
         (title (or (when entry (cdr (assoc "title" entry)))
                    (and (stringp pdf) (file-name-base pdf))
                    "Overview"))
         (suggested-name (downcase (replace-regexp-in-string "[^a-z0-9-]" "-" title)))
         (note-file (if is-bib
                        (expand-file-name (concat key ".org")
                                          (expand-file-name "literature" org-roam-directory))
                      ;; Prompt to save generic note in default-directory
                      (let ((default-dir default-directory))
                        (make-directory default-dir t)
                        (read-file-name "Save note as: " default-dir nil nil (concat suggested-name ".org"))))))
    (unless (file-directory-p (file-name-directory note-file))
      (make-directory (file-name-directory note-file) t))
    (unless (file-exists-p note-file)
      (with-temp-file note-file
        (if is-bib
            (insert (my/load-roam-bib-template key title))
          (insert (format "#+TITLE: %s\n* Overview\n:PROPERTIES:\n:ID: %s\n:NOTER_DOCUMENT: %s\n:END:\n* Analysis and Inference\n"
                          title (org-id-new) (or pdf "")))))
      (my/bibnote-normalize-file note-file pdf title))
    (find-file pdf)
    (split-window-right)
    (find-file note-file)
    (goto-char (point-min))
    (re-search-forward "^\\* ")
    ;; Kill any existing Org-noter sessions to prevent duplicates
    (when (bound-and-true-p org-noter--session)
      (org-noter-kill-session))
    ;; Start Org-noter session (no args)
    (org-noter)
    (message "Opened %s note → %s"
             (if is-bib "bibliography" "generic")
             (file-name-nondirectory note-file))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Calibre books – C-c i b (laptop only)
;; Workflow:
;; 1. M-x calibredb → opens Calibre library buffer.
;; 2. / term RET → optional: live-filter by text (title/author/tags).
;; 3. Move point to book → use n/p or arrow keys.
;; 4. C-c i b → opens book file left + Org note right in ~/org/books/.
;; ─────────────
(when (eq my-device 'laptop)
  (defun my/open-calibre-book-and-note ()
    "Open Calibre book (PDF/EPUB) and a standalone Org note in ~/org/books/.
This function integrates Calibredb with Org-mode for note-taking.
If the Org note for the selected book does not exist, it is created automatically
with metadata and a NOTER_DOCUMENT property."
    (interactive)
    (require 'calibredb)
    (unless (derived-mode-p 'calibredb-search-mode 'calibredb-show-mode)
      (call-interactively #'calibredb))
    (let* (;; Book entry at point in *calibredb-search* / *calibredb-show*.
           (candidate (car (calibredb-find-candidate-at-point)))
           ;; (message "CANDIDATE: %S" candidate) ; Uncomment for debugging.
           (id (calibredb-getattr candidate :id))
           ;; Use calibredb's actual metadata fields.
           (title (or (calibredb-getattr candidate :book-title)
                        (calibredb-getattr candidate :title)))
           (author (or (calibredb-getattr candidate :author-sort)
                        (calibredb-getattr candidate :author)))
           ;; Full values used inside the note.
           (title* (or title "Unknown"))
           (author* (or author "Unknown"))
           ;; Short filename: first author + title.
           (file-author
            (if (and author*
                     (string-match "\\`\\([^,&]+\\)" author*))
                (string-trim (match-string 1 author*))
              author*))
           (file-title (or title* "Unknown"))
           ;; Prefer main file (pdf/epub/etc.) resolved by calibredb.
           (book-path (or (calibredb-get-file-path candidate t)
                          (calibredb-get-file-path candidate nil)))
           ;; Notes directory under your default-directory (~/org/).
           (books-notes-dir (expand-file-name "books" default-directory))
           ;; Slug for filename: first-author-title, lowercased and cleaned.
           (slug (downcase
                  (replace-regexp-in-string
                   "[^a-z0-9 ]" ""
                   (format "%s - %s" file-author file-title))))
           (slug (replace-regexp-in-string " " "-" slug))
           (note-file (expand-file-name (concat slug ".org") books-notes-dir)))
   
      (message "ID=%S TITLE=%S AUTHOR=%S FILE=%S" id title author book-path)
      (unless book-path
        (user-error "No file for \"%s\" (ID: %s)" title* id))
      ;; Ensure notes directory exists.
      (make-directory books-notes-dir t)
      ;; Create note once, with full title/author and NOTER_DOCUMENT.
      (unless (file-exists-p note-file)
        (with-temp-file note-file
          (insert
           (format
            "#+TITLE: %s – %s\n#+AUTHOR: %s\n#+CREATED: %s\n#+ROAM_TAGS: book\n\n* Overview\n:PROPERTIES:\n:NOTER_DOCUMENT: %s\n:ID: %s\n:END:\n\n* Analysis and Inference\n\n"
            title* author* author*
            (format-time-string "%Y-%m-%d")
            (expand-file-name book-path)
            (org-id-new)))))
      ;; Optional post-processing of the note.
      (when (fboundp 'my/bibnote-normalize-file)
        (my/bibnote-normalize-file note-file (expand-file-name book-path) title*))
      ;; Open book left, note right.
      (find-file (expand-file-name book-path))
      (split-window-right)
      (other-window 1)
      (find-file note-file)
      ;; Move to the heading with drawer and start Org-noter
      (goto-char (point-min))
      (if (re-search-forward "^\\* Overview" nil t)
          (progn
            (org-entry-get nil "NOTER_DOCUMENT") ; Force Org to parse properties
            (org-noter))
        (message "Warning: No Overview heading found; Org-noter not started."))
      (message "Opened: %s by %s with Org-noter session" title* author*))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; Define my/get-image-dir-for-note
(defun my/get-image-dir-for-note (note-file)
  "Return directory for images for NOTE-FILE."
  (let ((base-dir (file-name-directory note-file)))
    (expand-file-name "images" base-dir)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Automate Image Capture for Annotations – Common Logic for All Types
;; ──────────────────────────────────────────────────────────────
(defun my/save-pdf-region-to-datestamp (&optional whole-page)
  "Save PDF region (or WHOLE-PAGE) as JPG and insert link at cursor in Org note."
  (interactive "P")
  (when (derived-mode-p 'pdf-view-mode)
    (require 'org-noter)
    ;; Ensure there is an Org-noter session
    (unless (bound-and-true-p org-noter--session)
      (when (y-or-n-p "No Org-noter session. Start one now? ")
        (org-noter)))
    (let* ((pdf-file (buffer-file-name))
           (note-win (org-noter--get-notes-window))
           (note-buf (when note-win (window-buffer note-win)))
           (note-file (when note-buf (buffer-file-name note-buf))))
      (unless note-file
        (user-error "No associated Org note window found. Use C-c i a / C-c i g to open PDF + note."))
      (let* ((image-dir (my/get-image-dir-for-note note-file))
             (timestamp (format-time-string "%Y-%m-%d-%H%M%S"))
             (filename (expand-file-name (format "%s.jpg" timestamp) image-dir))
             (resolution 150)
             (caption (read-string "Optional caption: "))
             raw-edges quads page-size pixel-width pixel-height crop-x crop-y crop-w crop-h
             (link-text (format "#+CAPTION: %s\n[[file:%s]]\n"
                                (if (string-empty-p caption) "Captured image" caption)
                                (file-relative-name filename (file-name-directory note-file)))))
        (make-directory image-dir t)
        (if whole-page
            ;; Whole page capture
            (shell-command
             (format "pdftoppm -jpeg -r %d -f %d -l %d '%s' > '%s'"
                     resolution
                     (pdf-view-current-page)
                     (pdf-view-current-page)
                     pdf-file filename))
          ;; Region capture
          (setq raw-edges (condition-case nil
                              (pdf-view-active-region)
                            (error nil)))
          (message "Debug: Raw edges = %S | Active? %s"
                   raw-edges (pdf-view-active-region-p))
          (setq quads (if (numberp (car-safe raw-edges))
                          (cdr raw-edges) ; new format: drop page number
                        raw-edges))
          (if (and quads
                   (listp quads)
                   (= (length quads) 1)
                   (let ((quad (car quads)))
                     (and (listp quad)
                          (= (length quad) 4)
                          (cl-every #'numberp quad))))
              (let ((quad (car quads)))
                (setq page-size (pdf-info-pagesize (pdf-view-current-page))
                      pixel-width (* (car page-size) (/ resolution 72.0))
                      pixel-height (* (cdr page-size) (/ resolution 72.0))
                      crop-x (* (nth 0 quad) pixel-width)
                      crop-y (* (nth 1 quad) pixel-height)
                      crop-w (* (- (nth 2 quad) (nth 0 quad)) pixel-width)
                      crop-h (* (- (nth 3 quad) (nth 1 quad)) pixel-height))
                (shell-command
                 (format "pdftoppm -jpeg -r %d -f %d -l %d -x %.0f -y %.0f -W %.0f -H %.0f '%s' > '%s'"
                         resolution
                         (pdf-view-current-page)
                         (pdf-view-current-page)
                         crop-x crop-y crop-w crop-h
                         pdf-file filename)))
            (user-error "No valid single rectangular region selected. Drag mouse to select or use C-c i S for whole page.")))
        ;; Insert link at cursor position in Org note
        (with-current-buffer note-buf
          (insert link-text)
          (save-buffer))
        ;; No clipboard copy
        (message "Saved → %s"
                 (file-relative-name filename (file-name-directory note-file)))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; Mode-local bindings for pdf-view (these are safe — not global prefixes)
(with-eval-after-load 'pdf-view
  ;; Bind drag event to ignore to block global override and let pdf-tools handle via down-mouse
  (define-key pdf-view-mode-map [drag-mouse-1] 'ignore)
  ;; Bind plain left-drag for standard region (reinforce default if needed)
  (define-key pdf-view-mode-map (kbd "<down-mouse-1>") 'pdf-view-mouse-set-region)
  ;; Bind Shift + left-drag for rectangular region (ideal for images/diagrams)
  (define-key pdf-view-mode-map (kbd "<S-down-mouse-1>") 'pdf-view-mouse-set-region-rectangle)
  (define-key pdf-view-mode-map (kbd "C-c i s") 'my/save-pdf-region-to-datestamp)
  (define-key pdf-view-mode-map (kbd "C-c i S") (lambda () (interactive) (my/save-pdf-region-to-datestamp t))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ──────────────────────────────────────────────────────────────
;; Org-roam capture template
;; ──────────────────────────────────────────────────────────────
(add-to-list 'org-roam-capture-templates
             '("b" "bibliography note" plain #'my/load-roam-bib-template
               :target (file+head "literature/${citar-citekey}.org" "")
               :unnarrowed t :immediate-finish t))
#+END_SRC

** Clipboard Copy for Inserted Annotations
#+BEGIN_SRC emacs-lisp
(with-eval-after-load 'org-noter
  (defun my/org-noter-copy-quoted-text-to-clipboard (orig &rest args)
    "Copy a simplified quoted note template (with essential properties) to clipboard after insertion."
    (let ((result (apply orig args)))
      (when (bound-and-true-p org-noter--session)
        (with-current-buffer (org-noter--session-notes-buffer org-noter--session)
          (save-excursion
            (goto-char (point-min))
            (when (re-search-forward "#\\+BEGIN_QUOTE" nil t)
              (let ((quote-start (point)))
                (when (re-search-forward "#\\+END_QUOTE" nil t)
                  (let* ((quoted-text (string-trim
                                       (buffer-substring-no-properties
                                        quote-start (match-beginning 0))))
                         (keywords (org-collect-keywords '("TITLE" "AUTHOR")))
                         (source (or (cadr (assoc "TITLE" keywords)) ""))
                         (author (or (cadr (assoc "AUTHOR" keywords)) ""))
                         (noter-page (org-entry-get nil "NOTER_PAGE" t))
                         (noter-doc (org-entry-get-with-inheritance "NOTER_DOCUMENT"))
                         (page (when (and noter-page
                                          (string-match "::\\([0-9]+\\)" noter-page))
                                 (match-string 1 noter-page)))
                         (pdf-link (or noter-page
                                       (when (and noter-doc page)
                                         (format "pdf:%s::%s" noter-doc page))))
                         (sentences (split-string quoted-text "\\. " t))
                         (first-sentences (mapconcat 'identity
                                                     (seq-take sentences 3) ". "))
                         (first-sentences-clean (string-trim first-sentences))
                         (short-title (if (> (length first-sentences-clean) 70)
                                          (concat (substring first-sentences-clean 0 67) "…")
                                        first-sentences-clean))
                         ;; First author (swap Last, First -> First Last)
                         (first-author-raw (car (split-string (or author "") " & ")))
                         (author-parts (split-string first-author-raw ", "))
                         (first-author (if (= (length author-parts) 2)
                                           (format "%s %s"
                                                   (cadr author-parts)
                                                   (car author-parts))
                                         first-author-raw))
                         ;; Title → main part before colon / dash
                         (title-parts (split-string source " – "))
                         (title (car title-parts))
                         (short-title-desc (mapconcat 'identity
                                                      (seq-take (split-string title ":") 1) ":"))
                         ;; add ", p. 13" if page exists
                         (page-suffix (if page
                                          (format ", p. %s" page)
                                        ""))
                         ;; Final link text
                         (link-desc (format "%s, %s%s"
                                            first-author short-title-desc page-suffix))
                         (pdf-link-file (when noter-doc
                                          (expand-file-name noter-doc)))
                         (pdf-link-file-formatted
                          (if pdf-link-file
                              (format "[[%s][%s]]" pdf-link-file link-desc)
                            ""))
                         (template
                          (format "* %s :ignore:\n:PROPERTIES:\n:AUTHOR: %s\n:PAGE: %s\n:PDF_LINK: %s\n:END:\n\n#+BEGIN_QUOTE\n%s\n#+END_QUOTE\n#+LATEX: \\begin{flushright}\n— %s\n#+LATEX: \\end{flushright}\n"
                                  short-title
                                  (or author "")
                                  (or page "")
                                  pdf-link
                                  quoted-text
                                  pdf-link-file-formatted)))
                    (kill-new template)
                    (message "Copied simplified quoted note template to clipboard."))))))))
      result))

  (advice-add 'org-noter-insert-note :around
              #'my/org-noter-copy-quoted-text-to-clipboard))

#+END_SRC


#+BEGIN_SRC emacs-lisp
(defun my/sanitize-image-winprops-in-pdf-window (&rest _args)
  "Reset broken `image-mode-winprops-alist` in PDF view before annotations."
  (let ((win (org-noter--get-doc-window)))
    (when (and win (window-live-p win))
      (with-selected-window win
        (let ((props (window-parameter nil 'image-mode-winprops-alist)))
          (unless (listp props)
            (set-window-parameter nil 'image-mode-winprops-alist nil))))))
  t) ;; return non-nil to signal advice success (optional)
(advice-add 'org-noter-insert-note :before #'my/sanitize-image-winprops-in-pdf-window)

(provide 'notextn)
;;; notextn.el ends here
#+END_SRC