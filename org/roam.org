#+TITLE: Org-Roam Zettelkasten Configuration
#+TODO: ACTIVE | CANCELLED
#+STARTUP: indent
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+DATE: 2025-07-12
#+CREATED: %U
#+LAST_MODIFIED: [2025-08-10 Sun 16:50]

* Purpose
Configure org-roam for Zettelkasten note-taking with unique IDs, backlinks, dailies, and dynamic tags from .filetags via my-org-read-filetags in org/filetags.org. Designed to be:
- **Future-proof**: Structured with comments and tables for easy updates; includes safe DB rebuilds.
- **Reliable**: Reproducible via straight.el with error handling and db autosync; fixes for citar-org-roam integration.
- **Minimal**: Lightweight setup with essential keybindings, no external dependencies beyond org-roam.
- **Portable**: Works on laptop (system-name: ram), Termux, tablet via device-aware paths.
- **Synced**: ~/.emacs.d/ and notes synced via GitHub[](https://github.com/chaicurioquest/emacs-config) and Syncthing.
- **Integrated**: Uses my-org-read-filetags for tag completion (shared with yankpad snippets), integrates with Zotero via org-roam-bibtex/Citar for bib notes, Org-noter for PDF annotations, and new features like transclusion and glossary autodetection.

* My Org-Roam Workflow                                             :workflow:
| Workflow              | Solution                             | Notes                                                         | Device   | Keybindings                                       |
|-----------------------|--------------------------------------|---------------------------------------------------------------|----------|-------------------------------------------------  |
| Find existing note    | org-roam-node-find                   | Search notes by title/ID/tags; Vertico completion             | All      | C-c r f                                           |
| Insert link to note   | org-roam-node-insert                 | Link to another note (backlinks auto-created)                 | All      | C-c r i                                           |
| Capture new note      | org-roam-capture                     | Create notes with templates (default, fleeting, permanent, journal, bibliography) | All | C-c r n                                           |
| Daily notes           | org-roam-dailies                     | Capture/goto today/previous/next/date                         | All      | C-c r d/T/P/N/D                                   |
| Add/remove tags       | my-org-roam-tag-add/remove           | Uses .filetags completion (from filetags.org)                 | All      | C-c r t/r                                         |
| Rebuild DB safely     | my/org-roam-safe-rebuild             | Clears and syncs DB; skips if PDF open                        | All      | C-c r s                                           |
| Graph UI              | org-roam-ui-open                     | Interactive graph (laptop only)                               | Laptop   | C-c r g                                           |
| Transclude content    | my/org-insert-transclude-from-id-with-front-author | Insert transcluded block from ID (new: 2026-02-18)     | All      | C-c r x                                           |
| Refile to tag targets | my-org-refile-to-tag-targets         | Refile to headings with :TAG_TARGET: (new: 2026-02-18)        | All      | C-c i R                                           |
| Glossary acronyms     | org-glossary-mode                    | Autodetect/expand in Org; LaTeX export handling               | All      | Auto-enabled (hook)                               |
| Bib integration       | citar-org-roam                       | Create/open notes for citations; Zotero sync                  | All      | C-c i n/N/C-n (via Citar)                         |
| PDF annotations       | org-noter                            | Sync notes with PDF; fixes for winprops/location              | All      | C-c i p (open PDF + noter)                        |
| Mail to Org           | mu4e-org-store-and-capture           | Capture emails as TODOs (laptop only)                         | Laptop   | C-c C-c (in mu4e-view)                            |
| Alerts/Notifications  | org-alert/mu4e-alert                 | Device-aware; sanitized messages                              | All      | Auto (hooks/timers)                               |

#+BEGIN_SRC emacs-lisp
;; Use id: links when interactively inserting links
  (require 'org-id)
  (setq org-id-link-to-org-use-id 'create-if-interactive) 
#+END_SRC

* ACTIVE Org-roam Setup

** Template preloading
#+BEGIN_SRC emacs-lisp
;; Helper Function for Template Preloading ${setupfile} for setup-latex file path in template
(defun my/load-template (filename)
  "Load template FILENAME from `user-emacs-directory` and replace ${setupfile}."
  (let ((template-path (expand-file-name filename user-emacs-directory)))
    (if (file-exists-p template-path)
        (with-temp-buffer
          (insert-file-contents template-path)
          (goto-char (point-min))
          (while (search-forward "${setupfile}" nil t)
            (replace-match (expand-file-name "latex/setup-latex.org" my/notes-root-dir) t t))
          (buffer-string))
      (message "Template %s not found; using fallback." template-path)
      "* Default Note\n:PROPERTIES:\n:ID: %^{id-or-auto}\n:END:\n%?\n- %U")))
#+END_SRC

** Org roam package installation
#+BEGIN_SRC emacs-lisp
(use-package org-roam
  :straight t
  :defer t
  :init
  (setq org-roam-completion-everywhere t
        org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  ;; NOTE: all global keybindings for org-roam are in keymaps.el (C-c r prefix).
  :config
  ;; Ensure directories exist
  (dolist (d (list org-roam-directory org-roam-dailies-directory))
  ;; Set DB location local to notes dir for sync
  (setq org-roam-db-location (expand-file-name "org-roam.db" org-roam-directory))
    (make-directory d t))
  (add-hook 'org-roam-mode-hook
            (lambda ()
              (unless (bound-and-true-p my/org-roam-initialized)
                (setq my/org-roam-initialized t)
                (org-roam-db-autosync-mode 1)
                (org-roam-db-sync)))))
#+END_SRC

** Org roam templates
#+BEGIN_SRC emacs-lisp
;; Used eval with progn to evaluate multiple setq forms and resolve stringp error by ensuring paths are strings
(setq org-roam-capture-templates
      `(("d" "default" plain ,(my/load-template "template/roam-default.org")
         :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "") :unnarrowed t)
        ("f" "fleeting" entry ,(my/load-template "template/roam-fleeting.org")
         :target (file+olp "fleeting.org" ("Fleeting Captures")) :empty-lines 1 :unnarrowed t)
        ("p" "permanent" plain ,(my/load-template "template/roam-permanent.org")
         :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "") :unnarrowed t)
        ("j" "journal" plain ,(my/load-template "template/roam-journal.org")
         :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "") :unnarrowed t)))

(setq org-roam-dailies-capture-templates
      `(("d" "default" plain ,(my/load-template "template/roam-dailies.org")
         :target (file+head "%<%Y-%m-%d>.org" "") :empty-lines 1 :prepend t :unnarrowed t)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package citar-org-roam
  :straight t
  :after (citar org-roam)
  :config
  (citar-org-roam-mode)
  (setq citar-org-roam-subdir "literature"
        citar-org-roam-note-title-template "${author editor} (${year issued date}) - ${title}"))
#+END_SRC

* ACTIVE Org roam functions
** Org-roam UI (Graph)
#+BEGIN_SRC emacs-lisp
(use-package org-roam-ui
  :if (eq my-device 'laptop)
  :straight (:host github :repo "org-roam/org-roam-ui" :branch "main")
  :config
  (setq org-roam-ui-sync-theme t
        org-roam-ui-follow t
        org-roam-ui-update-on-save t
        org-roam-ui-open-on-start nil))
#+END_SRC

** Helper: Add Tag via Filetags Completion
#+BEGIN_SRC emacs-lisp
(defun my-org-roam-tag-add ()
  "Add a tag to the current org-roam node with completion."
  (interactive)
  (let* ((all-tags (my-org-read-filetags))
         (completion-function (if (and (eq my-device 'laptop) (fboundp 'ivy-completing-read))
                                  (lambda (prompt coll) (ivy-completing-read prompt coll nil t))
                                'completing-read))
         (selected-tag (funcall completion-function "Select tag: " all-tags)))
    (when selected-tag (org-roam-tag-add (list selected-tag)))))
#+END_SRC

** Helper: Remove Tag via Filetags Completion
#+BEGIN_SRC emacs-lisp
(defun my-org-roam-tag-remove ()
  "Remove a tag from the current org-roam node with completion."
  (interactive)
  (let* ((current-tags (org-roam-node-tags (org-roam-node-at-point)))
         (completion-function (if (and (eq my-device 'laptop) (fboundp 'ivy-completing-read))
                                  (lambda (prompt coll) (ivy-completing-read prompt coll nil t))
                                'completing-read))
         (selected-tag (funcall completion-function "Remove tag: " current-tags)))
    (when selected-tag (org-roam-tag-remove (list selected-tag)))))
#+END_SRC

* Ensure Org-Roam DB is ready immediately (prevents citar-org-roam errors)
#+BEGIN_SRC emacs-lisp
;; Safe DB rebuild
(defun my/org-roam-safe-rebuild ()
  "Rebuild DB safely without race conditions."
  (interactive)
  (unless (get-buffer-window "*Org PDF*")  ; Skip if PDF open
    (when (bound-and-true-p org-roam-db-autosync-mode) (org-roam-db-autosync-mode -1))
    (org-roam-db-clear-all)
    (org-roam-db-sync)
    (org-roam-db-autosync-mode 1)
    (message "Org-roam DB rebuilt safely")))
(provide 'roam)
#+END_SRC
